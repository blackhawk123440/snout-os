name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  check-migrations:
    name: Check Prisma Migrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Check for schema changes without migrations
        working-directory: apps/api
        run: |
          # Generate migration in dry-run mode
          pnpm prisma migrate dev --create-only --name ci_check || true
          
          # Check if any new migrations were created
          NEW_MIGRATIONS=$(git status --porcelain prisma/migrations/ | wc -l)
          if [ "$NEW_MIGRATIONS" -gt 0 ]; then
            echo "❌ Schema changes detected but migrations not committed!"
            echo "Run: cd apps/api && pnpm prisma migrate dev --name <migration_name>"
            git status prisma/migrations/
            exit 1
          fi
      
      - name: Verify indexes migration exists
        working-directory: apps/api
        run: |
          if [ ! -f "prisma/migrations/*/migration.sql" ]; then
            echo "❌ No migrations found!"
            exit 1
          fi
          
          # Check if indexes migration exists (by looking for CREATE INDEX statements)
          INDEX_MIGRATION=$(find prisma/migrations -name "*.sql" -exec grep -l "CREATE INDEX" {} \; | head -1)
          if [ -z "$INDEX_MIGRATION" ]; then
            echo "⚠️  Warning: No migration with CREATE INDEX found"
            echo "Performance indexes may be missing"
          else
            echo "✅ Found indexes migration: $INDEX_MIGRATION"
          fi

  test-audit-invariants:
    name: Audit & Invariant Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: snoutos
          POSTGRES_PASSWORD: snoutos_test
          POSTGRES_DB: snoutos_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Setup database
        working-directory: apps/api
        env:
          DATABASE_URL: postgresql://snoutos:snoutos_test@localhost:5432/snoutos_test
        run: |
          pnpm prisma migrate deploy
          pnpm prisma generate
      
      - name: Run audit completeness tests
        working-directory: apps/api
        env:
          DATABASE_URL: postgresql://snoutos:snoutos_test@localhost:5432/snoutos_test
          TEST_DATABASE_URL: postgresql://snoutos:snoutos_test@localhost:5432/snoutos_test
        run: pnpm test:audit
      
      - name: Run invariant tests
        working-directory: apps/api
        env:
          DATABASE_URL: postgresql://snoutos:snoutos_test@localhost:5432/snoutos_test
          TEST_DATABASE_URL: postgresql://snoutos:snoutos_test@localhost:5432/snoutos_test
        run: pnpm test:invariants

  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Type check API
        working-directory: apps/api
        run: pnpm typecheck
      
      - name: Type check Web
        working-directory: apps/web
        run: pnpm typecheck
