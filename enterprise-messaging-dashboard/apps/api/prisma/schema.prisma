// SnoutOS Enterprise Messaging Dashboard - Database Schema
// Version: 1.0
// Date: 2026-01-19

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  users            User[]
  clients          Client[]
  sitters          Sitter[]
  messageNumbers   MessageNumber[]
  threads          Thread[]
  assignmentWindows AssignmentWindow[]
  routingOverrides  RoutingOverride[]
  messages         Message[]
  policyViolations  PolicyViolation[]
  automations      Automation[]
  automationExecutions AutomationExecution[]
  alerts           Alert[]
  auditEvents      AuditEvent[]

  @@index([createdAt])
}

model User {
  id           String    @id @default(uuid())
  orgId        String
  role         String    // 'owner' | 'sitter' | 'admin_future'
  name         String
  email        String    @unique
  passwordHash String
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sitter       Sitter?

  @@index([orgId])
  @@index([email])
  @@index([role])
}

model Client {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contacts        ClientContact[]
  threads         Thread[]

  @@index([orgId])
}

model ClientContact {
  id        String   @id @default(uuid())
  clientId  String
  e164      String   // E.164 format
  label     String?  // e.g., "Mobile", "Home"
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, e164])
  @@index([e164])
}

model Sitter {
  id        String   @id @default(uuid())
  orgId     String
  userId    String?  @unique
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user               User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  assignedNumbers    MessageNumber[]
  assignmentWindows  AssignmentWindow[]
  routingOverrides   RoutingOverride[]
  threads            Thread[]

  @@index([orgId])
  @@index([active])
}

// ============================================
// NUMBER MANAGEMENT
// ============================================

model MessageNumber {
  id                 String        @id @default(uuid())
  orgId              String
  e164               String        @unique
  class              String        // 'front_desk' | 'sitter' | 'pool'
  status             String        // 'active' | 'quarantined' | 'inactive'
  assignedSitterId   String?
  quarantinedReason  String?
  quarantineReleaseAt DateTime?
  providerType       String        // 'twilio' | 'mock'
  providerNumberSid  String?
  purchaseCostCents  Int?
  purchaseDate       DateTime?
  lastUsedAt         DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedSitter  Sitter?      @relation(fields: [assignedSitterId], references: [id], onDelete: SetNull)
  threads        Thread[]

  @@index([orgId])
  @@index([class])
  @@index([status])
  @@index([assignedSitterId])
  @@index([e164])
}

// ============================================
// THREADS & MESSAGING
// ============================================

model Thread {
  id            String   @id @default(uuid())
  orgId         String
  clientId      String
  sitterId      String?
  numberId      String
  threadType    String   // 'front_desk' | 'assignment' | 'pool' | 'other'
  status        String   // 'active' | 'inactive'
  createdAt     DateTime @default(now())
  lastActivityAt DateTime @default(now())
  ownerUnreadCount Int   @default(0)

  organization       Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client             Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sitter             Sitter?           @relation(fields: [sitterId], references: [id], onDelete: SetNull)
  messageNumber      MessageNumber     @relation(fields: [numberId], references: [id], onDelete: Restrict)
  participants       ThreadParticipant[]
  assignmentWindows  AssignmentWindow[]
  routingOverrides   RoutingOverride[]
  messages           Message[]
  policyViolations   PolicyViolation[]

  @@unique([orgId, clientId]) // Enforce: one thread per client per org
  @@index([orgId])
  @@index([clientId])
  @@index([sitterId])
  @@index([numberId])
  @@index([status])
  @@index([lastActivityAt])
  @@index([orgId, lastActivityAt(sort: Desc)]) // Performance: threads by org, most recent first
}

model ThreadParticipant {
  id              String   @id @default(uuid())
  threadId        String
  participantType String   // 'owner' | 'sitter' | 'client'
  participantId   String
  createdAt       DateTime @default(now())

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, participantType, participantId])
  @@index([threadId])
}

model Message {
  id                  String   @id @default(uuid())
  orgId               String
  threadId            String
  direction           String   // 'inbound' | 'outbound'
  senderType          String   // 'client' | 'sitter' | 'owner' | 'system' | 'automation'
  senderId            String?
  body                String   @db.Text
  redactedBody        String?  @db.Text
  hasPolicyViolation  Boolean  @default(false)
  createdAt           DateTime @default(now())
  providerMessageSid  String?

  organization    Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  thread          Thread          @relation(fields: [threadId], references: [id], onDelete: Cascade)
  deliveries      MessageDelivery[]
  policyViolations PolicyViolation[]

  @@index([orgId])
  @@index([threadId])
  @@index([direction])
  @@index([createdAt])
  @@index([providerMessageSid])
  @@index([threadId, createdAt(sort: Desc)]) // Performance: messages by thread, most recent first
  @@unique([providerMessageSid]) // Invariant: idempotency uniqueness
}

model MessageDelivery {
  id                  String   @id @default(uuid())
  messageId           String
  attemptNo           Int      @default(1)
  status              String   // 'queued' | 'sent' | 'delivered' | 'failed'
  providerErrorCode   String?
  providerErrorMessage String? @db.Text
  providerRaw         Json?
  createdAt           DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// ASSIGNMENTS & ROUTING
// ============================================

model AssignmentWindow {
  id        String    @id @default(uuid())
  orgId    String
  threadId String
  sitterId String
  startsAt DateTime
  endsAt   DateTime
  bookingRef String?
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  thread      Thread       @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sitter      Sitter       @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([threadId])
  @@index([sitterId])
  @@index([startsAt])
  @@index([endsAt])
  @@index([threadId, startsAt, endsAt]) // Performance: window lookups by thread + time range
  @@index([sitterId, startsAt, endsAt]) // Performance: window lookups by sitter + time range
}

model RoutingOverride {
  id              String    @id @default(uuid())
  orgId           String
  threadId        String
  targetType      String    // 'owner_inbox' | 'sitter' | 'client'
  targetId        String?
  startsAt        DateTime
  endsAt          DateTime?
  reason          String    @db.Text
  createdByUserId String
  createdAt       DateTime  @default(now())
  removedAt       DateTime?

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  thread      Thread       @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sitter      Sitter?      @relation(fields: [targetId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([threadId])
  @@index([startsAt])
  @@index([endsAt])
}

// ============================================
// POLICY & COMPLIANCE
// ============================================

model PolicyViolation {
  id                String   @id @default(uuid())
  orgId             String
  threadId          String
  messageId         String?
  violationType     String   // 'phone' | 'email' | 'url' | 'social' | 'other'
  detectedSummary   String   @db.Text
  detectedRedacted  String?  @db.Text
  actionTaken       String   // 'blocked' | 'warned' | 'overridden' | 'allowed'
  status            String   // 'open' | 'resolved' | 'dismissed'
  createdAt         DateTime @default(now())
  resolvedByUserId  String?
  resolvedAt        DateTime?

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  thread       Thread       @relation(fields: [threadId], references: [id], onDelete: Cascade)
  message      Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([threadId])
  @@index([status])
  @@index([createdAt])
  @@index([orgId, status, createdAt(sort: Desc)]) // Performance: violations by org + status, most recent first
}

// ============================================
// AUTOMATIONS
// ============================================

model Automation {
  id              String    @id @default(uuid())
  orgId           String
  name            String
  description     String?   @db.Text
  lane            String    // 'front_desk' | 'sitter' | 'billing' | 'system'
  status          String    // 'draft' | 'active' | 'paused' | 'archived'
  trigger         Json
  conditions      Json
  actions         Json
  templates       Json
  lastExecutedAt  DateTime?
  lastTestedAt    DateTime?
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  organization        Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  automationExecutions AutomationExecution[]

  @@index([orgId])
  @@index([status])
  @@index([lane])
}

model AutomationExecution {
  id              String   @id @default(uuid())
  orgId           String
  automationId    String
  status          String   // 'success' | 'failed' | 'skipped' | 'test'
  triggerContext  Json
  conditionResults Json?
  actionResults   Json?
  error           String?  @db.Text
  createdAt       DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  automation   Automation   @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([automationId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// ALERTS & ESCALATION
// ============================================

model Alert {
  id            String    @id @default(uuid())
  orgId         String
  severity      String    // 'critical' | 'warning' | 'info'
  type          String
  title         String
  description   String    @db.Text
  entityType    String?
  entityId      String?
  status        String    // 'open' | 'resolved' | 'dismissed'
  createdAt     DateTime  @default(now())
  resolvedAt    DateTime?
  resolvedByUserId String?

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@index([orgId, status, severity, createdAt(sort: Desc)]) // Performance: alerts by org + status + severity, most recent first
}

// ============================================
// AUDIT & OBSERVABILITY
// ============================================

model AuditEvent {
  id            String   @id @default(uuid())
  orgId         String
  actorType     String   // 'owner' | 'sitter' | 'client' | 'system' | 'automation'
  actorId       String?
  entityType    String?
  entityId      String?
  eventType     String
  ts            DateTime @default(now())
  correlationIds Json
  payload       Json
  schemaVersion Int      @default(1)

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([actorType])
  @@index([entityType])
  @@index([eventType])
  @@index([ts])
  @@index([orgId, ts(sort: Desc)]) // Performance: audit events by org, most recent first
  @@index([entityType, entityId]) // Performance: lookups by entity
  @@index([correlationIds], type: Gin) // Performance: GIN index for JSONB correlation_ids queries
}
