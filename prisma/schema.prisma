generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Rate {
  id        String    @id @default(uuid())
  service   String
  duration  Int
  baseRate  Float
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  @@unique([service, duration], name: "service_duration")
}

model Booking {
  id                   String                 @id @default(uuid())
  firstName            String
  lastName             String
  phone                String
  email                String?
  address              String?
  pickupAddress        String?
  dropoffAddress       String?
  service              String
  startAt              DateTime
  endAt                DateTime
  totalPrice           Float
  pricingSnapshot      String?                @db.Text // JSON string of CanonicalPricingBreakdown (Phase 2)
  status               String                 @default("pending")
  assignmentType       String? // "direct" or "pool" - null means not yet assigned
  notes                String?
  stripePaymentLinkUrl String?
  tipLinkUrl           String?
  paymentStatus        String                 @default("unpaid")
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  afterHours           Boolean                @default(false)
  holiday              Boolean                @default(false)
  quantity             Int                    @default(1)
  pets                 Pet[]
  sitter               Sitter?                @relation(fields: [sitterId], references: [id])
  sitterId             String?
  timeSlots            TimeSlot[]
  messages             Message[]
  reports              Report[]
  sitterPoolOffers     SitterPoolOffer[]
  sitterPool           BookingSitterPool[]    @relation("BookingSitterPool")
  client               Client?                @relation(fields: [clientId], references: [id])
  clientId             String?
  tags                 BookingTagAssignment[]
  discountUsage        DiscountUsage?
  customFields         CustomFieldValue[]
  eventLogs            EventLog[] // Phase 3: Event log entries for this booking
  statusHistory        BookingStatusHistory[] // Phase 7.3: Booking status change history

  @@index([sitterId])
  @@index([status])
  @@index([createdAt])
  @@index([clientId])
}

model Pet {
  id           String             @id @default(uuid())
  name         String
  species      String
  breed        String?
  age          Int?
  notes        String?
  booking      Booking            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId    String
  customFields CustomFieldValue[]

  @@index([bookingId])
}

model TimeSlot {
  id        String   @id @default(uuid())
  startAt   DateTime
  endAt     DateTime
  duration  Int
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String
  createdAt DateTime @default(now())

  @@index([bookingId])
}

model Sitter {
  id                   String              @id @default(uuid())
  firstName            String
  lastName             String
  phone                String
  email                String
  active               Boolean             @default(true)
  commissionPercentage Float               @default(80.0) // Percentage of booking totalPrice (70-80%)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  bookings             Booking[]
  personalPhone        String?
  openphonePhone       String?
  phoneType            String?
  stripeAccountId      String?
  sitterPoolOffers     SitterPoolOffer[]
  bookingSitterPool    BookingSitterPool[] @relation("SitterPoolMembers")
  tierHistory          SitterTierHistory[]
  currentTierId        String?
  currentTier          SitterTier?         @relation(fields: [currentTierId], references: [id])
  customFields         CustomFieldValue[]
  // Link to User if this sitter has auth access (Gate B Phase 1)
  user                 User?
  PayrollLineItem      PayrollLineItem[]
  PayrollAdjustment    PayrollAdjustment[]

  @@index([active])
  @@index([currentTierId])
}

model SitterPoolOffer {
  id               String   @id @default(uuid())
  bookingId        String
  sitterId         String?
  sitterIds        String?
  message          String?
  expiresAt        DateTime
  status           String   @default("active")
  responses        String   @default("[]")
  acceptedSitterId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sitter           Sitter?  @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([sitterId])
  @@index([status])
}

model BookingSitterPool {
  id              String   @id @default(uuid())
  bookingId       String
  sitterId        String
  createdAt       DateTime @default(now())
  createdByUserId String?
  booking         Booking  @relation("BookingSitterPool", fields: [bookingId], references: [id], onDelete: Cascade)
  sitter          Sitter   @relation("SitterPoolMembers", fields: [sitterId], references: [id], onDelete: Cascade)

  @@unique([bookingId, sitterId])
  @@index([bookingId])
  @@index([sitterId])
}

model Message {
  id        String   @id @default(uuid())
  direction String
  from      String
  to        String
  body      String
  status    String
  booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String?
  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([direction])
}

model Setting {
  id        String   @id @default(uuid())
  updatedAt DateTime @updatedAt
  key       String   @unique
  value     String
  category  String?
  label     String?
  createdAt DateTime @default(now())

  @@index([category])
}

model Report {
  id             String    @id @default(uuid())
  bookingId      String?
  booking        Booking?  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  content        String
  mediaUrls      String?
  visitStarted   DateTime?
  visitCompleted DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([bookingId])
}

model GoogleCalendarAccount {
  id           String    @id @default(uuid())
  email        String    @unique
  provider     String    @default("google")
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  calendarId   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([email])
}

// ============================================
// AUTOMATION CENTER MODELS
// ============================================

model Automation {
  id          String                @id @default(uuid())
  name        String
  description String?
  trigger     String // e.g., "booking.created", "sitter.assigned"
  enabled     Boolean               @default(true)
  priority    Int                   @default(0) // Higher priority runs first
  conditions  AutomationCondition[]
  actions     AutomationAction[]
  logs        AutomationLog[]
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([trigger])
  @@index([enabled])
}

model AutomationCondition {
  id           String     @id @default(uuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  field        String // e.g., "service", "bookingTotal", "dayOfWeek"
  operator     String // e.g., "equals", "greaterThan", "contains"
  value        String // JSON string for complex values
  logic        String? // "AND" or "OR" - how to combine with next condition
  order        Int        @default(0)

  @@index([automationId])
}

model AutomationAction {
  id           String     @id @default(uuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  type         String // e.g., "sendSMS", "sendEmail", "updateStatus", "assignSitter"
  config       String // JSON string with action-specific configuration
  order        Int        @default(0)
  delayMinutes Int?       @default(0) // Delay before executing

  @@index([automationId])
}

model AutomationLog {
  id           String     @id @default(uuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  trigger      String
  context      String // JSON string with event context
  conditions   String // JSON string with condition results
  actions      String // JSON string with action results
  success      Boolean
  error        String?
  executedAt   DateTime   @default(now())

  @@index([automationId])
  @@index([executedAt])
  @@index([success])
}

// ============================================
// CUSTOM FIELD SYSTEM
// ============================================

model CustomField {
  id               String             @id @default(uuid())
  entityType       String // "client", "pet", "sitter", "booking"
  label            String
  fieldType        String // "string", "number", "boolean", "date", "list"
  required         Boolean            @default(false)
  visibleToOwner   Boolean            @default(true)
  visibleToSitter  Boolean            @default(false)
  visibleToClient  Boolean            @default(false)
  editableBySitter Boolean            @default(false)
  editableByClient Boolean            @default(false)
  showInTemplates  Boolean            @default(false)
  options          String? // JSON array for list type fields
  defaultValue     String?
  order            Int                @default(0)
  values           CustomFieldValue[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([entityType])
}

model CustomFieldValue {
  id            String      @id @default(uuid())
  customFieldId String
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  entityId      String // ID of the client, pet, sitter, or booking
  value         String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  Pet           Pet?        @relation(fields: [petId], references: [id], onDelete: SetNull)
  petId         String?
  Sitter        Sitter?     @relation(fields: [sitterId], references: [id], onDelete: SetNull)
  sitterId      String?
  Client        Client?     @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId      String?
  Booking       Booking?    @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  bookingId     String?

  @@unique([customFieldId, entityId])
  @@index([entityId])
  @@index([petId])
  @@index([sitterId])
  @@index([clientId])
  @@index([bookingId])
}

// ============================================
// SERVICE CONFIGURATION
// ============================================

model ServiceConfig {
  id                 String   @id @default(uuid())
  serviceName        String   @unique
  basePrice          Float?
  defaultDuration    Int? // minutes
  category           String? // e.g., "walking", "sitting", "care"
  minBookingNotice   Int? // hours
  gpsCheckInRequired Boolean  @default(false)
  photosRequired     Boolean  @default(false)
  allowedSitterTiers String? // JSON array of tier IDs
  allowedSitterTypes String? // JSON array
  weekendMultiplier  Float?   @default(1.0)
  holidayMultiplier  Float?   @default(1.0)
  timeOfDayRules     String? // JSON object with rules
  holidayBehavior    String? // JSON object
  enabled            Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([serviceName])
  @@index([category])
}

// ============================================
// PRICING ENGINE
// ============================================

model PricingRule {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        String // "fee", "discount", "multiplier"
  conditions  String // JSON object with conditions
  calculation String // JSON object with calculation logic
  priority    Int      @default(0)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
  @@index([type])
}

// ============================================
// DISCOUNT ENGINE
// ============================================

model Discount {
  id              String          @id @default(uuid())
  code            String?         @unique // For discount codes
  name            String
  type            String // "code", "firstTime", "loyalty", "referral", "automatic"
  value           Float // Percentage or fixed amount
  valueType       String // "percentage" or "fixed"
  minBookingTotal Float?
  maxDiscount     Float?
  validFrom       DateTime?
  validUntil      DateTime?
  usageLimit      Int?
  usageCount      Int             @default(0)
  conditions      String? // JSON object with conditions
  enabled         Boolean         @default(true)
  bookings        DiscountUsage[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([code])
  @@index([type])
  @@index([enabled])
}

model DiscountUsage {
  id         String   @id @default(uuid())
  discountId String
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount     Float
  usedAt     DateTime @default(now())

  @@unique([bookingId]) // One discount per booking
  @@index([discountId])
  @@index([bookingId])
}

// ============================================
// BOOKING FORM BUILDER
// ============================================

model FormField {
  id              String   @id @default(uuid())
  serviceType     String? // null = applies to all services
  label           String
  fieldType       String // "text", "email", "phone", "date", "select", "textarea", "checkbox"
  required        Boolean  @default(false)
  order           Int      @default(0)
  options         String? // JSON array for select fields
  placeholder     String?
  helpText        String?
  visibleToSitter Boolean  @default(false)
  visibleToClient Boolean  @default(true)
  includeInReport Boolean  @default(false)
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([serviceType])
}

// ============================================
// TEMPLATE ENGINE
// ============================================

model MessageTemplate {
  id          String            @id @default(uuid())
  name        String
  type        String // "sms", "email"
  category    String // "client", "sitter", "owner", "report", "invoice", "onboarding"
  templateKey String            @unique // e.g., "booking.confirmed.client.sms"
  subject     String? // For emails
  body        String
  variables   String? // JSON array of available variables
  version     Int               @default(1)
  isActive    Boolean           @default(true)
  history     TemplateHistory[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([category])
  @@index([type])
  @@index([templateKey])
}

model TemplateHistory {
  id         String          @id @default(uuid())
  templateId String
  template   MessageTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  subject    String?
  body       String
  version    Int
  changedBy  String? // User ID or system
  changedAt  DateTime        @default(now())

  @@index([templateId])
}

// ============================================
// PERMISSION & ROLE SYSTEM
// ============================================

model Role {
  id          String           @id @default(uuid())
  name        String           @unique // "owner", "admin", "manager", "leadSitter", "sitter", "accountant"
  displayName String
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RolePermission {
  id       String  @id @default(uuid())
  roleId   String
  role     Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  resource String // e.g., "client.phone", "booking.edit", "sitter.payout"
  action   String // "read", "write", "delete", "manage"
  granted  Boolean @default(true)

  @@unique([roleId, resource, action])
  @@index([roleId])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String // References Sitter.id or a future User model
  userType  String // "sitter" or "admin"
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, userType, roleId])
  @@index([userId, userType])
}

// ============================================
// SITTER TIER & PERFORMANCE ENGINE
// ============================================

model SitterTier {
  id                        String              @id @default(uuid())
  name                      String              @unique
  pointTarget               Int
  minCompletionRate         Float? // 0-100
  minResponseRate           Float? // 0-100
  benefits                  String? // JSON object
  priorityLevel             Int                 @default(0) // Higher = more priority in routing
  canTakeHouseSits          Boolean             @default(false)
  canTakeTwentyFourHourCare Boolean             @default(false)
  isDefault                 Boolean             @default(false)
  // Canonical tier permissions (Enterprise Tier System)
  canJoinPools              Boolean             @default(false) // Can join sitter pools
  canAutoAssign             Boolean             @default(false) // Can be auto-assigned without owner approval
  canOvernight              Boolean             @default(false) // Can handle overnight/extended care
  canSameDay                Boolean             @default(false) // Can handle same-day emergency bookings
  canHighValue              Boolean             @default(false) // Can handle high-value clients
  canRecurring              Boolean             @default(false) // Can accept recurring clients
  canLeadPool               Boolean             @default(false) // Can lead sitter pools (Elite only)
  canOverrideDecline        Boolean             @default(false) // Can override certain decline rules (Elite only)
  // Commission split (percentage sitter receives, e.g., 70 = 70% to sitter, 30% to owner)
  commissionSplit           Float               @default(70.0) // Default commission percentage
  // Visual properties
  badgeColor                String? // Hex color for badge
  badgeStyle                String? // "outline" | "filled" | "accent" - for visual differentiation
  // Description and progression info
  description               String? // What this tier means
  progressionRequirements   String? // JSON object with requirements to advance
  sitters                   SitterTierHistory[]
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  Sitter                    Sitter[]

  @@index([priorityLevel])
}

model SitterTierHistory {
  id             String     @id @default(uuid())
  sitterId       String
  sitter         Sitter     @relation(fields: [sitterId], references: [id], onDelete: Cascade)
  tierId         String
  tier           SitterTier @relation(fields: [tierId], references: [id], onDelete: Cascade)
  points         Int
  completionRate Float?
  responseRate   Float?
  periodStart    DateTime
  periodEnd      DateTime?
  // Audit fields for tier changes
  changedBy      String? // User ID who made the change (null if system/automation)
  reason         String? // Reason for tier change (promotion/demotion)
  metadata       String? // JSON string for additional context
  createdAt      DateTime   @default(now())

  @@index([sitterId])
  @@index([tierId])
  @@index([periodStart])
  @@index([createdAt])
}

model ServicePointWeight {
  id        String   @id @default(uuid())
  service   String
  duration  Int? // null = applies to all durations
  points    Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([service, duration])
  @@index([service])
}

// ============================================
// CLIENT MANAGEMENT
// ============================================

model Client {
  id            String             @id @default(uuid())
  firstName     String
  lastName      String
  phone         String
  email         String?
  address       String?
  tags          String? // JSON array
  lifetimeValue Float              @default(0)
  lastBookingAt DateTime?
  notes         String?
  customFields  CustomFieldValue[]
  bookings      Booking[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([phone])
  @@index([email])
}

// ============================================
// BOOKING EXTENSIONS
// ============================================

model BookingTag {
  id        String                 @id @default(uuid())
  name      String                 @unique
  color     String? // Hex color
  bookings  BookingTagAssignment[]
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
}

model BookingTagAssignment {
  id        String     @id @default(uuid())
  bookingId String
  tagId     String
  tag       BookingTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  booking   Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([bookingId, tagId])
  @@index([bookingId])
  @@index([tagId])
}

model BookingPipeline {
  id          String   @id @default(uuid())
  name        String   @unique
  order       Int      @default(0)
  isDefault   Boolean  @default(false)
  transitions String? // JSON array of allowed next statuses
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
}

// ============================================
// BUSINESS SETTINGS
// ============================================

model BusinessSettings {
  id              String   @id @default(uuid())
  businessName    String
  businessPhone   String?
  businessEmail   String?
  businessAddress String?
  timeZone        String   @default("America/New_York")
  operatingHours  String? // JSON object
  holidays        String? // JSON array
  taxSettings     String? // JSON object
  contentBlocks   String? // JSON object with policies, terms, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// AUTHENTICATION MODELS (Gate B Phase 1)
// ============================================

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String? // For credentials provider
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  // Link to Sitter if this user is a sitter (one-to-one relation)
  sitterId      String?   @unique
  sitter        Sitter?   @relation(fields: [sitterId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([sitterId])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// EXISTING UTILITY MODELS (referenced by code)
// ============================================

model BaselineSnapshot {
  id                   String   @id @default(uuid())
  bookingId            String
  timestamp            DateTime @default(now())
  bookingFormTotal     Float?
  calendarViewTotal    Float?
  sitterDashboardTotal Float?
  ownerDashboardTotal  Float?
  stripePaymentTotal   Float?
  storedTotalPrice     Float?
  calculatedBreakdown  String?  @db.Text // JSON string
  notes                String?  @db.Text

  @@index([bookingId])
  @@index([timestamp])
}

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  metadata    String?  @db.Text // JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([enabled])
}

// ============================================
// EVENT LOG (Phase 3: Audit Backbone)
// ============================================

model EventLog {
  id             String   @id @default(uuid())
  eventType      String // e.g., "automation.run", "booking.created", "payment.success"
  automationType String? // Automation type if eventType is "automation.run" (e.g., "bookingConfirmation", "nightBeforeReminder")
  status         String // "success", "failed", "skipped", "pending"
  error          String?  @db.Text // Error message if status is "failed"
  metadata       String?  @db.Text // JSON string for additional context (inputs, outputs, etc.)
  bookingId      String?
  booking        Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now())

  @@index([eventType])
  @@index([automationType])
  @@index([status])
  @@index([bookingId])
  @@index([createdAt])
}

// ============================================
// BOOKING STATUS HISTORY (Phase 7.3)
// ============================================

model BookingStatusHistory {
  id         String   @id @default(uuid())
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  fromStatus String? // Previous status (null for initial status)
  toStatus   String // New status
  changedBy  String? // User ID who made the change (null if system/automation)
  reason     String?  @db.Text // Optional reason for status change
  metadata   String?  @db.Text // JSON string for additional context
  createdAt  DateTime @default(now())

  @@index([bookingId])
  @@index([toStatus])
  @@index([createdAt])
  @@index([changedBy])
}

// Stripe Payment Read Models
model StripeCharge {
  id              String    @id // Stripe charge ID
  amount          Int // Amount in cents
  amountRefunded  Int       @default(0)
  currency        String    @default("usd")
  status          String // succeeded, pending, failed
  description     String?   @db.Text
  customerId      String? // Stripe customer ID
  customerEmail   String?
  customerName    String?
  paymentMethod   String? // card, bank_account, etc.
  paymentIntentId String? // Stripe payment intent ID
  invoiceId       String? // Stripe invoice ID
  bookingId       String? // Linked booking ID
  refunded        Boolean   @default(false)
  refundedAt      DateTime?
  createdAt       DateTime // Stripe created timestamp
  syncedAt        DateTime  @default(now()) @updatedAt

  @@index([customerId])
  @@index([bookingId])
  @@index([status])
  @@index([createdAt])
  @@index([syncedAt])
}

model StripeRefund {
  id              String   @id // Stripe refund ID
  chargeId        String // Stripe charge ID
  amount          Int // Amount in cents
  currency        String   @default("usd")
  reason          String? // duplicate, fraudulent, requested_by_customer
  status          String // succeeded, pending, failed, canceled
  paymentIntentId String? // Stripe payment intent ID
  createdAt       DateTime // Stripe created timestamp
  syncedAt        DateTime @default(now()) @updatedAt

  @@index([chargeId])
  @@index([status])
  @@index([createdAt])
}

model StripePayout {
  id                  String    @id // Stripe payout ID
  amount              Int // Amount in cents
  currency            String    @default("usd")
  status              String // paid, pending, in_transit, canceled, failed
  arrivalDate         DateTime? // When payout arrives
  description         String?   @db.Text
  statementDescriptor String?
  createdAt           DateTime // Stripe created timestamp
  syncedAt            DateTime  @default(now()) @updatedAt

  @@index([status])
  @@index([arrivalDate])
  @@index([createdAt])
}

model StripeBalanceTransaction {
  id          String   @id // Stripe balance transaction ID
  amount      Int // Amount in cents (can be negative for fees)
  currency    String   @default("usd")
  type        String // charge, payment, refund, payout, etc.
  description String?  @db.Text
  fee         Int      @default(0) // Fee amount in cents
  net         Int // Net amount after fees
  chargeId    String? // Related charge ID
  payoutId    String? // Related payout ID
  createdAt   DateTime // Stripe created timestamp
  syncedAt    DateTime @default(now()) @updatedAt

  @@index([type])
  @@index([chargeId])
  @@index([payoutId])
  @@index([createdAt])
}

// Payroll Models
model PayrollRun {
  id             String              @id @default(uuid())
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  status         String              @default("draft") // draft, pending, approved, paid, canceled
  totalAmount    Float
  totalSitters   Int
  approvedBy     String? // User ID
  approvedAt     DateTime?
  paidAt         DateTime?
  notes          String?             @db.Text
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  lineItems      PayrollLineItem[]
  adjustments    PayrollAdjustment[]

  @@index([payPeriodStart])
  @@index([payPeriodEnd])
  @@index([status])
}

model PayrollLineItem {
  id               String     @id @default(uuid())
  payrollRunId     String
  payrollRun       PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  sitterId         String
  sitter           Sitter     @relation(fields: [sitterId], references: [id])
  bookingCount     Int
  totalEarnings    Float
  commissionRate   Float
  commissionAmount Float
  adjustments      Float      @default(0) // Sum of bonuses - deductions
  netAmount        Float
  notes            String?    @db.Text
  createdAt        DateTime   @default(now())

  @@index([payrollRunId])
  @@index([sitterId])
}

model PayrollAdjustment {
  id           String     @id @default(uuid())
  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  sitterId     String
  sitter       Sitter     @relation(fields: [sitterId], references: [id])
  type         String // bonus, deduction
  amount       Float
  reason       String     @db.Text
  createdBy    String? // User ID
  createdAt    DateTime   @default(now())

  @@index([payrollRunId])
  @@index([sitterId])
}
