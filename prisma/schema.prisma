generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Rate {
  id        String    @id @default(uuid())
  service   String
  duration  Int
  baseRate  Float
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  @@unique([service, duration], name: "service_duration")
}

model Booking {
  id                   String                 @id @default(uuid())
  firstName            String
  lastName             String
  phone                String
  email                String?
  address              String?
  pickupAddress        String?
  dropoffAddress       String?
  service              String
  startAt              DateTime
  endAt                DateTime
  totalPrice           Float
  pricingSnapshot      String?                @db.Text // JSON string of CanonicalPricingBreakdown (Phase 2)
  status               String                 @default("pending")
  assignmentType       String? // "direct" or "pool" - null means not yet assigned
  dispatchStatus       String                 @default("auto") // auto | manual_required | manual_in_progress | assigned
  manualDispatchReason String?                @db.Text
  manualDispatchAt     DateTime?
  notes                String?
  stripePaymentLinkUrl String?
  tipLinkUrl           String?
  paymentStatus        String                 @default("unpaid")
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  afterHours           Boolean                @default(false)
  holiday              Boolean                @default(false)
  quantity             Int                    @default(1)
  pets                 Pet[]
  sitter               Sitter?                @relation(fields: [sitterId], references: [id])
  sitterId             String?
  timeSlots            TimeSlot[]
  messages             Message[]
  reports              Report[]
  offerEvents          OfferEvent[]
  visitEvents          VisitEvent[]
  // Phase 2: Assignment windows (prepared for Phase 2)
  assignmentWindows    AssignmentWindow[]
  sitterPoolOffers     SitterPoolOffer[]
  sitterPool           BookingSitterPool[]    @relation("BookingSitterPool")
  client               Client?                @relation(fields: [clientId], references: [id])
  clientId             String?
  tags                 BookingTagAssignment[]
  discountUsage        DiscountUsage?
  customFields         CustomFieldValue[]
  eventLogs            EventLog[] // Phase 3: Event log entries for this booking
  statusHistory        BookingStatusHistory[] // Phase 7.3: Booking status change history
  calendarEvents       BookingCalendarEvent[] // Google Calendar event mappings

  @@index([sitterId])
  @@index([status])
  @@index([createdAt])
  @@index([clientId])
}

model Pet {
  id           String             @id @default(uuid())
  name         String
  species      String
  breed        String?
  age          Int?
  notes        String?
  booking      Booking            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId    String
  customFields CustomFieldValue[]

  @@index([bookingId])
}

model TimeSlot {
  id        String   @id @default(uuid())
  startAt   DateTime
  endAt     DateTime
  duration  Int
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String
  createdAt DateTime @default(now())

  @@index([bookingId])
}

model Sitter {
  id                   String              @id @default(uuid())
  firstName            String
  lastName             String
  phone                String
  email                String
  active               Boolean             @default(true)
  commissionPercentage Float               @default(80.0) // Percentage of booking totalPrice (70-80%)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  bookings             Booking[]
  personalPhone        String?
  openphonePhone       String?
  phoneType            String?
  stripeAccountId      String?
  sitterPoolOffers     SitterPoolOffer[]
  bookingSitterPool    BookingSitterPool[] @relation("SitterPoolMembers")
  tierHistory          SitterTierHistory[]
  currentTierId        String?
  currentTier          SitterTier?         @relation(fields: [currentTierId], references: [id])
  customFields         CustomFieldValue[]
  // Link to User if this sitter has auth access (Gate B Phase 1)
  user                 User?
  PayrollLineItem      PayrollLineItem[]
  PayrollAdjustment    PayrollAdjustment[]
  // Phase 1: Messaging number infrastructure
  maskedNumber         SitterMaskedNumber?
  // Phase 2: Assignment windows (prepared for Phase 2)
  assignmentWindows    AssignmentWindow[]
  // Google Calendar integration
  googleAccessToken    String?   @db.Text // Encrypted access token
  googleRefreshToken   String?   @db.Text // Encrypted refresh token
  googleTokenExpiry    DateTime?
  googleCalendarId     String?   @default("primary")
  calendarSyncEnabled  Boolean   @default(false)
  // SRS System relations
  tierSnapshots        SitterTierSnapshot[]
  serviceEvents        SitterServiceEvent[]
  timeOffs             SitterTimeOff[]
  offerEvents          OfferEvent[]
  visitEvents          VisitEvent[]
  compensation         SitterCompensation?
  metricsWindows       SitterMetricsWindow[]
  calendarEvents       BookingCalendarEvent[]

  @@index([active])
  @@index([currentTierId])
}

model SitterPoolOffer {
  id               String   @id @default(uuid())
  bookingId        String
  sitterId         String?
  sitterIds        String?
  message          String?
  expiresAt        DateTime
  status           String   @default("active")
  responses        String   @default("[]")
  acceptedSitterId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sitter           Sitter?  @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([sitterId])
  @@index([status])
}

model BookingSitterPool {
  id              String   @id @default(uuid())
  bookingId       String
  sitterId        String
  createdAt       DateTime @default(now())
  createdByUserId String?
  booking         Booking  @relation("BookingSitterPool", fields: [bookingId], references: [id], onDelete: Cascade)
  sitter          Sitter   @relation("SitterPoolMembers", fields: [sitterId], references: [id], onDelete: Cascade)

  @@unique([bookingId, sitterId])
  @@index([bookingId])
  @@index([sitterId])
}

model Message {
  id        String   @id @default(uuid())
  direction String
  from      String
  to        String
  body      String
  status    String
  booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String?
  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([direction])
}

model Setting {
  id        String   @id @default(uuid())
  updatedAt DateTime @updatedAt
  key       String   @unique
  value     String
  category  String?
  label     String?
  createdAt DateTime @default(now())

  @@index([category])
}

model Report {
  id             String    @id @default(uuid())
  bookingId      String?
  booking        Booking?  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  content        String
  mediaUrls      String?
  visitStarted   DateTime?
  visitCompleted DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([bookingId])
}

model GoogleCalendarAccount {
  id           String    @id @default(uuid())
  email        String    @unique
  provider     String    @default("google")
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  calendarId   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([email])
}

// ============================================
// AUTOMATION CENTER MODELS (Enterprise Rebuild)
// ============================================

model Automation {
  id          String   @id @default(uuid())
  name        String
  description String?
  isEnabled   Boolean  @default(true)
  scope       String   @default("global") // global, org, sitter, client
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String? // User ID or system
  updatedBy   String? // User ID or system
  version     Int      @default(1)
  status      String   @default("draft") // draft, active, paused, archived

  // Relations
  trigger         AutomationTrigger?
  conditionGroups AutomationConditionGroup[]
  actions         AutomationAction[]
  templates       AutomationTemplate[]
  runs            AutomationRun[]

  @@index([isEnabled])
  @@index([status])
  @@index([scope])
  @@index([createdAt])
}

model AutomationTrigger {
  id            String     @id @default(uuid())
  automationId  String     @unique
  automation    Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  triggerType   String // e.g., "booking.created", "booking.statusChanged", "time.scheduled"
  triggerConfig String     @db.Text // JSON string with trigger-specific configuration

  @@index([triggerType])
}

model AutomationConditionGroup {
  id           String                @id @default(uuid())
  automationId String
  automation   Automation            @relation(fields: [automationId], references: [id], onDelete: Cascade)
  operator     String                @default("all") // "all" or "any"
  order        Int                   @default(0)
  conditions   AutomationCondition[]

  @@index([automationId])
  @@index([order])
}

model AutomationCondition {
  id              String                   @id @default(uuid())
  groupId         String
  group           AutomationConditionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  conditionType   String // e.g., "booking.service", "booking.status", "client.isNew"
  conditionConfig String                   @db.Text // JSON string with condition-specific configuration
  order           Int                      @default(0)

  @@index([groupId])
  @@index([order])
}

model AutomationAction {
  id           String     @id @default(uuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  actionType   String // e.g., "sendSMS", "sendEmail", "updateBookingStatus", "assignSitter"
  actionConfig String     @db.Text // JSON string with action-specific configuration
  order        Int        @default(0)

  @@index([automationId])
  @@index([order])
}

model AutomationTemplate {
  id            String     @id @default(uuid())
  automationId  String
  automation    Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  templateType  String // "sms", "email", "internalMessage"
  subject       String? // For emails
  body          String     @db.Text
  variablesUsed String?    @db.Text // JSON array of variable names
  previewText   String?    @db.Text
  updatedAt     DateTime   @updatedAt
  updatedBy     String? // User ID

  @@index([automationId])
  @@index([templateType])
}

model AutomationRun {
  id               String     @id @default(uuid())
  automationId     String
  automation       Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  triggeredAt      DateTime   @default(now())
  status           String     @default("queued") // queued, running, success, failed, skipped, test
  reason           String?    @db.Text // If skipped
  targetEntityType String? // booking, client, sitter, payrollRun, payment, messageThread
  targetEntityId   String?
  idempotencyKey   String?    @unique
  metadata         String?    @db.Text // JSON string
  correlationId    String? // For EventLog correlation

  // Relations
  steps AutomationRunStep[]

  @@index([automationId])
  @@index([status])
  @@index([triggeredAt])
  @@index([targetEntityType, targetEntityId])
  @@index([correlationId])
  @@index([idempotencyKey])
}

model AutomationRunStep {
  id              String        @id @default(uuid())
  automationRunId String
  automationRun   AutomationRun @relation(fields: [automationRunId], references: [id], onDelete: Cascade)
  stepType        String // "conditionCheck", "actionExecute"
  status          String // "success", "failed", "skipped"
  input           String?       @db.Text // JSON string
  output          String?       @db.Text // JSON string
  error           String?       @db.Text // JSON string
  createdAt       DateTime      @default(now())

  @@index([automationRunId])
  @@index([stepType])
  @@index([status])
}

// ============================================
// CUSTOM FIELD SYSTEM
// ============================================

model CustomField {
  id               String             @id @default(uuid())
  entityType       String // "client", "pet", "sitter", "booking"
  label            String
  fieldType        String // "string", "number", "boolean", "date", "list"
  required         Boolean            @default(false)
  visibleToOwner   Boolean            @default(true)
  visibleToSitter  Boolean            @default(false)
  visibleToClient  Boolean            @default(false)
  editableBySitter Boolean            @default(false)
  editableByClient Boolean            @default(false)
  showInTemplates  Boolean            @default(false)
  options          String? // JSON array for list type fields
  defaultValue     String?
  order            Int                @default(0)
  values           CustomFieldValue[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([entityType])
}

model CustomFieldValue {
  id            String      @id @default(uuid())
  customFieldId String
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  entityId      String // ID of the client, pet, sitter, or booking
  value         String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  Pet           Pet?        @relation(fields: [petId], references: [id], onDelete: SetNull)
  petId         String?
  Sitter        Sitter?     @relation(fields: [sitterId], references: [id], onDelete: SetNull)
  sitterId      String?
  Client        Client?     @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId      String?
  Booking       Booking?    @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  bookingId     String?

  @@unique([customFieldId, entityId])
  @@index([entityId])
  @@index([petId])
  @@index([sitterId])
  @@index([clientId])
  @@index([bookingId])
}

// ============================================
// SERVICE CONFIGURATION
// ============================================

model ServiceConfig {
  id                 String   @id @default(uuid())
  serviceName        String   @unique
  basePrice          Float?
  defaultDuration    Int? // minutes
  category           String? // e.g., "walking", "sitting", "care"
  minBookingNotice   Int? // hours
  gpsCheckInRequired Boolean  @default(false)
  photosRequired     Boolean  @default(false)
  allowedSitterTiers String? // JSON array of tier IDs
  allowedSitterTypes String? // JSON array
  weekendMultiplier  Float?   @default(1.0)
  holidayMultiplier  Float?   @default(1.0)
  timeOfDayRules     String? // JSON object with rules
  holidayBehavior    String? // JSON object
  enabled            Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([serviceName])
  @@index([category])
}

// ============================================
// PRICING ENGINE
// ============================================

model PricingRule {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        String // "fee", "discount", "multiplier"
  conditions  String // JSON object with conditions
  calculation String // JSON object with calculation logic
  priority    Int      @default(0)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
  @@index([type])
}

// ============================================
// DISCOUNT ENGINE
// ============================================

model Discount {
  id              String          @id @default(uuid())
  code            String?         @unique // For discount codes
  name            String
  type            String // "code", "firstTime", "loyalty", "referral", "automatic"
  value           Float // Percentage or fixed amount
  valueType       String // "percentage" or "fixed"
  minBookingTotal Float?
  maxDiscount     Float?
  validFrom       DateTime?
  validUntil      DateTime?
  usageLimit      Int?
  usageCount      Int             @default(0)
  conditions      String? // JSON object with conditions
  enabled         Boolean         @default(true)
  bookings        DiscountUsage[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([code])
  @@index([type])
  @@index([enabled])
}

model DiscountUsage {
  id         String   @id @default(uuid())
  discountId String
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount     Float
  usedAt     DateTime @default(now())

  @@unique([bookingId]) // One discount per booking
  @@index([discountId])
  @@index([bookingId])
}

// ============================================
// BOOKING FORM BUILDER
// ============================================

model FormField {
  id              String   @id @default(uuid())
  serviceType     String? // null = applies to all services
  label           String
  fieldType       String // "text", "email", "phone", "date", "select", "textarea", "checkbox"
  required        Boolean  @default(false)
  order           Int      @default(0)
  options         String? // JSON array for select fields
  placeholder     String?
  helpText        String?
  visibleToSitter Boolean  @default(false)
  visibleToClient Boolean  @default(true)
  includeInReport Boolean  @default(false)
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([serviceType])
}

// ============================================
// TEMPLATE ENGINE
// ============================================

model MessageTemplate {
  id          String            @id @default(uuid())
  name        String
  type        String // "sms", "email"
  category    String // "client", "sitter", "owner", "report", "invoice", "onboarding"
  templateKey String            @unique // e.g., "booking.confirmed.client.sms"
  subject     String? // For emails
  body        String
  variables   String? // JSON array of available variables
  version     Int               @default(1)
  isActive    Boolean           @default(true)
  history     TemplateHistory[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([category])
  @@index([type])
  @@index([templateKey])
}

model TemplateHistory {
  id         String          @id @default(uuid())
  templateId String
  template   MessageTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  subject    String?
  body       String
  version    Int
  changedBy  String? // User ID or system
  changedAt  DateTime        @default(now())

  @@index([templateId])
}

// ============================================
// PERMISSION & ROLE SYSTEM
// ============================================

model Role {
  id          String           @id @default(uuid())
  name        String           @unique // "owner", "admin", "manager", "leadSitter", "sitter", "accountant"
  displayName String
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RolePermission {
  id       String  @id @default(uuid())
  roleId   String
  role     Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  resource String // e.g., "client.phone", "booking.edit", "sitter.payout"
  action   String // "read", "write", "delete", "manage"
  granted  Boolean @default(true)

  @@unique([roleId, resource, action])
  @@index([roleId])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String // References Sitter.id or a future User model
  userType  String // "sitter" or "admin"
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, userType, roleId])
  @@index([userId, userType])
}

// ============================================
// SITTER TIER & PERFORMANCE ENGINE
// ============================================

model SitterTier {
  id                        String              @id @default(uuid())
  name                      String              @unique
  pointTarget               Int
  minCompletionRate         Float? // 0-100
  minResponseRate           Float? // 0-100
  benefits                  String? // JSON object
  priorityLevel             Int                 @default(0) // Higher = more priority in routing
  canTakeHouseSits          Boolean             @default(false)
  canTakeTwentyFourHourCare Boolean             @default(false)
  isDefault                 Boolean             @default(false)
  // Canonical tier permissions (Enterprise Tier System)
  canJoinPools              Boolean             @default(false) // Can join sitter pools
  canAutoAssign             Boolean             @default(false) // Can be auto-assigned without owner approval
  canOvernight              Boolean             @default(false) // Can handle overnight/extended care
  canSameDay                Boolean             @default(false) // Can handle same-day emergency bookings
  canHighValue              Boolean             @default(false) // Can handle high-value clients
  canRecurring              Boolean             @default(false) // Can accept recurring clients
  canLeadPool               Boolean             @default(false) // Can lead sitter pools (Elite only)
  canOverrideDecline        Boolean             @default(false) // Can override certain decline rules (Elite only)
  // Commission split (percentage sitter receives, e.g., 70 = 70% to sitter, 30% to owner)
  commissionSplit           Float               @default(70.0) // Default commission percentage
  // Visual properties
  badgeColor                String? // Hex color for badge
  badgeStyle                String? // "outline" | "filled" | "accent" - for visual differentiation
  // Description and progression info
  description               String? // What this tier means
  progressionRequirements   String? // JSON object with requirements to advance
  sitters                   SitterTierHistory[]
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  Sitter                    Sitter[]

  @@index([priorityLevel])
}

model SitterTierHistory {
  id             String     @id @default(uuid())
  sitterId       String
  sitter         Sitter     @relation(fields: [sitterId], references: [id], onDelete: Cascade)
  tierId         String
  tier           SitterTier @relation(fields: [tierId], references: [id], onDelete: Cascade)
  points         Int
  completionRate Float?
  responseRate   Float?
  periodStart    DateTime
  periodEnd      DateTime?
  // Audit fields for tier changes
  changedBy      String? // User ID who made the change (null if system/automation)
  reason         String? // Reason for tier change (promotion/demotion)
  metadata       String? // JSON string for additional context
  createdAt      DateTime   @default(now())

  @@index([sitterId])
  @@index([tierId])
  @@index([periodStart])
  @@index([createdAt])
}

model ServicePointWeight {
  id        String   @id @default(uuid())
  service   String
  duration  Int? // null = applies to all durations
  points    Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([service, duration])
  @@index([service])
}

// ============================================
// CLIENT MANAGEMENT
// ============================================

model Client {
  id            String             @id @default(uuid())
  firstName     String
  lastName      String
  phone         String
  email         String?
  address       String?
  tags          String? // JSON array
  lifetimeValue Float              @default(0)
  lastBookingAt DateTime?
  notes         String?
  customFields  CustomFieldValue[]
  bookings      Booking[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([phone])
  @@index([email])
}

// ============================================
// BOOKING EXTENSIONS
// ============================================

model BookingTag {
  id        String                 @id @default(uuid())
  name      String                 @unique
  color     String? // Hex color
  bookings  BookingTagAssignment[]
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
}

model BookingTagAssignment {
  id        String     @id @default(uuid())
  bookingId String
  tagId     String
  tag       BookingTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  booking   Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([bookingId, tagId])
  @@index([bookingId])
  @@index([tagId])
}

model BookingPipeline {
  id          String   @id @default(uuid())
  name        String   @unique
  order       Int      @default(0)
  isDefault   Boolean  @default(false)
  transitions String? // JSON array of allowed next statuses
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
}

// ============================================
// BUSINESS SETTINGS
// ============================================

model BusinessSettings {
  id              String   @id @default(uuid())
  businessName    String
  businessPhone   String?
  businessEmail   String?
  businessAddress String?
  timeZone        String   @default("America/New_York")
  operatingHours  String? // JSON object
  holidays        String? // JSON array
  taxSettings     String? // JSON object
  contentBlocks   String? // JSON object with policies, terms, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// AUTHENTICATION MODELS (Gate B Phase 1)
// ============================================

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String? // For credentials provider
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  // Link to Sitter if this user is a sitter (one-to-one relation)
  sitterId      String?   @unique
  sitter        Sitter?   @relation(fields: [sitterId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([sitterId])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// EXISTING UTILITY MODELS (referenced by code)
// ============================================

model BaselineSnapshot {
  id                   String   @id @default(uuid())
  bookingId            String
  timestamp            DateTime @default(now())
  bookingFormTotal     Float?
  calendarViewTotal    Float?
  sitterDashboardTotal Float?
  ownerDashboardTotal  Float?
  stripePaymentTotal   Float?
  storedTotalPrice     Float?
  calculatedBreakdown  String?  @db.Text // JSON string
  notes                String?  @db.Text

  @@index([bookingId])
  @@index([timestamp])
}

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  metadata    String?  @db.Text // JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([enabled])
}

// ============================================
// EVENT LOG (Phase 3: Audit Backbone)
// ============================================

model EventLog {
  id             String   @id @default(uuid())
  eventType      String // e.g., "automation.run", "booking.created", "payment.success"
  automationType String? // Automation type if eventType is "automation.run" (e.g., "bookingConfirmation", "nightBeforeReminder")
  status         String // "success", "failed", "skipped", "pending"
  error          String?  @db.Text // Error message if status is "failed"
  metadata       String?  @db.Text // JSON string for additional context (inputs, outputs, etc.)
  bookingId      String?
  booking        Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now())

  @@index([eventType])
  @@index([automationType])
  @@index([status])
  @@index([bookingId])
  @@index([createdAt])
}

// ============================================
// BOOKING STATUS HISTORY (Phase 7.3)
// ============================================

model BookingStatusHistory {
  id         String   @id @default(uuid())
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  fromStatus String? // Previous status (null for initial status)
  toStatus   String // New status
  changedBy  String? // User ID who made the change (null if system/automation)
  reason     String?  @db.Text // Optional reason for status change
  metadata   String?  @db.Text // JSON string for additional context
  createdAt  DateTime @default(now())

  @@index([bookingId])
  @@index([toStatus])
  @@index([createdAt])
  @@index([changedBy])
}

// Stripe Payment Read Models
model StripeCharge {
  id              String    @id // Stripe charge ID
  amount          Int // Amount in cents
  amountRefunded  Int       @default(0)
  currency        String    @default("usd")
  status          String // succeeded, pending, failed
  description     String?   @db.Text
  customerId      String? // Stripe customer ID
  customerEmail   String?
  customerName    String?
  paymentMethod   String? // card, bank_account, etc.
  paymentIntentId String? // Stripe payment intent ID
  invoiceId       String? // Stripe invoice ID
  bookingId       String? // Linked booking ID
  refunded        Boolean   @default(false)
  refundedAt      DateTime?
  createdAt       DateTime // Stripe created timestamp
  syncedAt        DateTime  @default(now()) @updatedAt

  @@index([customerId])
  @@index([bookingId])
  @@index([status])
  @@index([createdAt])
  @@index([syncedAt])
}

model StripeRefund {
  id              String   @id // Stripe refund ID
  chargeId        String // Stripe charge ID
  amount          Int // Amount in cents
  currency        String   @default("usd")
  reason          String? // duplicate, fraudulent, requested_by_customer
  status          String // succeeded, pending, failed, canceled
  paymentIntentId String? // Stripe payment intent ID
  createdAt       DateTime // Stripe created timestamp
  syncedAt        DateTime @default(now()) @updatedAt

  @@index([chargeId])
  @@index([status])
  @@index([createdAt])
}

model StripePayout {
  id                  String    @id // Stripe payout ID
  amount              Int // Amount in cents
  currency            String    @default("usd")
  status              String // paid, pending, in_transit, canceled, failed
  arrivalDate         DateTime? // When payout arrives
  description         String?   @db.Text
  statementDescriptor String?
  createdAt           DateTime // Stripe created timestamp
  syncedAt            DateTime  @default(now()) @updatedAt

  @@index([status])
  @@index([arrivalDate])
  @@index([createdAt])
}

model StripeBalanceTransaction {
  id          String   @id // Stripe balance transaction ID
  amount      Int // Amount in cents (can be negative for fees)
  currency    String   @default("usd")
  type        String // charge, payment, refund, payout, etc.
  description String?  @db.Text
  fee         Int      @default(0) // Fee amount in cents
  net         Int // Net amount after fees
  chargeId    String? // Related charge ID
  payoutId    String? // Related payout ID
  createdAt   DateTime // Stripe created timestamp
  syncedAt    DateTime @default(now()) @updatedAt

  @@index([type])
  @@index([chargeId])
  @@index([payoutId])
  @@index([createdAt])
}

// Payroll Models
model PayrollRun {
  id             String              @id @default(uuid())
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  status         String              @default("draft") // draft, pending, approved, paid, canceled
  totalAmount    Float
  totalSitters   Int
  approvedBy     String? // User ID
  approvedAt     DateTime?
  paidAt         DateTime?
  notes          String?             @db.Text
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  lineItems      PayrollLineItem[]
  adjustments    PayrollAdjustment[]

  @@index([payPeriodStart])
  @@index([payPeriodEnd])
  @@index([status])
}

model PayrollLineItem {
  id               String     @id @default(uuid())
  payrollRunId     String
  payrollRun       PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  sitterId         String
  sitter           Sitter     @relation(fields: [sitterId], references: [id])
  bookingCount     Int
  totalEarnings    Float
  commissionRate   Float
  commissionAmount Float
  adjustments      Float      @default(0) // Sum of bonuses - deductions
  netAmount        Float
  notes            String?    @db.Text
  createdAt        DateTime   @default(now())

  @@index([payrollRunId])
  @@index([sitterId])
}

model PayrollAdjustment {
  id           String     @id @default(uuid())
  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  sitterId     String
  sitter       Sitter     @relation(fields: [sitterId], references: [id])
  type         String // bonus, deduction
  amount       Float
  reason       String     @db.Text
  createdBy    String? // User ID
  createdAt    DateTime   @default(now())

  @@index([payrollRunId])
  @@index([sitterId])
}

// ============================================
// MESSAGING SYSTEM (Messaging Master Spec V1)
// ============================================

model MessageAccount {
  id                 String   @id @default(uuid())
  orgId              String
  provider           String // e.g., "twilio"
  providerConfigJson String?  @db.Text // JSON string with provider-specific config
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([orgId])
  @@index([provider])
}

model MessageNumber {
  id                 String              @id @default(uuid())
  orgId              String
  provider           String // e.g., "twilio"
  providerNumberSid  String // Provider's number identifier
  e164               String // E.164 format phone number
  market             String? // e.g., "US"
  status             String              @default("active") // active, disabled
  // Phase 1: Number class infrastructure
  numberClass        String              @default("pool") // "front_desk" | "sitter" | "pool"
  assignedSitterId   String? // For sitter numbers
  ownerId            String? // For front desk numbers
  isRotating         Boolean             @default(false) // For pool numbers
  rotationPriority   Int? // For pool number rotation
  lastAssignedAt     DateTime? // For pool rotation tracking
  // Relations
  sitterMaskedNumber SitterMaskedNumber?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  MessageThread      MessageThread[]

  @@index([orgId])
  @@index([provider])
  @@index([e164])
  @@index([status])
  @@index([numberClass])
  @@index([assignedSitterId])
}

// Provider Credentials (encrypted at rest)
model ProviderCredential {
  id            String   @id @default(uuid())
  orgId         String   @unique
  providerType  String   @default("twilio") // 'twilio', 'openphone', etc.
  encryptedConfig String @db.Text // Encrypted JSON: { accountSid, authToken }
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orgId])
}

model MessageThread {
  id                     String    @id @default(uuid())
  orgId                  String
  scope                  String // client_booking, client_general, owner_sitter, internal
  bookingId              String?
  clientId               String?
  assignedSitterId       String?
  status                 String    @default("open") // open, closed, archived
  providerSessionSid     String? // Provider's session identifier for masking
  maskedNumberE164       String? // Masked phone number visible to client
  // Phase 1: Number class infrastructure
  numberClass            String? // "front_desk" | "sitter" | "pool" (inherited from assigned number)
  messageNumberId        String? // FK to MessageNumber (optional for backward compatibility)
  isOneTimeClient        Boolean   @default(false)
  isMeetAndGreet         Boolean   @default(false)
  meetAndGreetApprovedAt DateTime?
  // Phase 2: Assignment window (will be added in Phase 2)
  assignmentWindowId     String?
  lastMessageAt          DateTime?
  lastInboundAt          DateTime?
  lastOutboundAt         DateTime?
  ownerUnreadCount       Int       @default(0)
  // Legacy field for backward compatibility
  threadType             String? // RELATIONSHIP, JOB, BROADCAST_INTERNAL (deprecated, use scope)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Relations
  participants        MessageParticipant[]
  events              MessageEvent[]
  assignmentAudits    ThreadAssignmentAudit[]
  responseRecords     ResponseRecord[]
  messageNumber       MessageNumber?          @relation(fields: [messageNumberId], references: [id], onDelete: SetNull)
  assignmentWindows   AssignmentWindow[]
  AntiPoachingAttempt AntiPoachingAttempt[]
  offerEvents         OfferEvent[]
  visitEvents         VisitEvent[]
  responseLinks       MessageResponseLink[]

  @@index([orgId])
  @@index([bookingId])
  @@index([clientId])
  @@index([assignedSitterId])
  @@index([status])
  @@index([lastMessageAt])
  @@index([numberClass])
  @@index([messageNumberId])
  @@index([assignmentWindowId])
}

model MessageParticipant {
  id                     String   @id @default(uuid())
  threadId               String
  orgId                  String
  role                   String // client, sitter, owner, system
  userId                 String? // User ID if role is sitter/owner
  clientId               String? // Client ID if role is client
  displayName            String
  realE164               String // Real phone number (stored securely)
  providerParticipantSid String? // Provider's participant identifier
  // Legacy fields for backward compatibility
  entityType             String? // USER, CLIENT (deprecated, use role + userId/clientId)
  entityId               String? // ID of the entity (deprecated, use userId/clientId)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([orgId])
  @@index([role])
  @@index([userId])
  @@index([clientId])
}

model MessageEvent {
  id                          String   @id @default(uuid())
  threadId                    String
  orgId                       String
  direction                   String // inbound, outbound
  actorType                   String // client, sitter, owner, system
  actorUserId                 String?
  actorClientId               String?
  providerMessageSid          String? // Provider's message identifier
  body                        String   @db.Text
  mediaJson                   String?  @db.Text // JSON array of media URLs
  createdAt                   DateTime @default(now())
  deliveryStatus              String   @default("queued") // queued, sent, delivered, failed, received
  failureCode                 String?
  failureDetail               String?  @db.Text
  requiresResponse            Boolean  @default(false)
  responseToMessageId         String?  // FK to MessageEvent (the message this responds to)
  responseSlaSeconds          Int?
  responsibleSitterIdSnapshot String?
  promptId                    String?
  metadataJson                String?  @db.Text // JSON object
  correlationIds              String?  @db.Text // JSON array for audit trail
  answeredAt                  DateTime? // When this message was answered (if requiresResponse=true)
  // Legacy fields for backward compatibility (delivery retry)
  attemptCount                Int?
  lastAttemptAt               DateTime?
  providerErrorCode           String?
  providerErrorMessage        String?

  // Relations
  thread              MessageThread        @relation(fields: [threadId], references: [id], onDelete: Cascade)
  AntiPoachingAttempt AntiPoachingAttempt?
  responseTo          MessageEvent?        @relation("ResponseTo", fields: [responseToMessageId], references: [id], onDelete: SetNull)
  responses           MessageEvent[]       @relation("ResponseTo")
  requiresResponseLinks MessageResponseLink[] @relation("RequiresResponse")
  responseLinks       MessageResponseLink[] @relation("Response")

  @@index([threadId])
  @@index([orgId])
  @@index([direction])
  @@index([actorType])
  @@index([deliveryStatus])
  @@index([createdAt])
  @@index([providerMessageSid])
  @@index([requiresResponse])
  @@index([responseToMessageId])
  @@index([answeredAt])
}

model ThreadAssignmentAudit {
  id           String   @id @default(uuid())
  orgId        String
  threadId     String
  fromSitterId String?
  toSitterId   String?
  actorUserId  String // User ID who made the change
  reason       String?  @db.Text
  createdAt    DateTime @default(now())

  // Relations
  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([threadId])
  @@index([actorUserId])
  @@index([createdAt])
}

model OptOutState {
  id        String   @id @default(uuid())
  orgId     String
  clientId  String?
  phoneE164 String
  state     String // opted_in, opted_out
  source    String // inbound_keyword, admin_override, import
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, phoneE164])
  @@index([orgId])
  @@index([phoneE164])
  @@index([state])
}

model ResponseRecord {
  id                       String    @id @default(uuid())
  orgId                    String
  threadId                 String
  bookingId                String?
  inboundMessageEventId    String // ID of the inbound MessageEvent that triggered this
  responsibleSitterId      String?
  slaSeconds               Int?
  inboundAt                DateTime
  resolutionStatus         String    @default("pending") // pending, replied, escalated, expired, ignored
  resolvedAt               DateTime?
  resolvedByMessageEventId String?
  responseSeconds          Int?
  escalationReason         String?   @db.Text
  ignoreReason             String?   @db.Text
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  // Relations
  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([threadId])
  @@index([bookingId])
  @@index([responsibleSitterId])
  @@index([resolutionStatus])
  @@index([inboundAt])
}

// ============================================
// PHASE 1: NUMBER INFRASTRUCTURE
// ============================================

model SitterMaskedNumber {
  id                     String    @id @default(uuid())
  orgId                  String
  sitterId               String    @unique
  messageNumberId        String    @unique // FK to MessageNumber (unique for one-to-one relation)
  providerParticipantSid String? // Provider's participant ID
  status                 String    @default("active") // active, deactivated, reassigned
  assignedAt             DateTime  @default(now())
  deactivatedAt          DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Relations
  sitter        Sitter        @relation(fields: [sitterId], references: [id], onDelete: Cascade)
  messageNumber MessageNumber @relation(fields: [messageNumberId], references: [id], onDelete: Restrict)

  @@index([orgId])
  @@index([sitterId])
  @@index([status])
}

// ============================================
// PHASE 2: ASSIGNMENT WINDOW (prepared for Phase 2)
// ============================================

model AssignmentWindow {
  id        String   @id @default(uuid())
  orgId     String
  threadId  String
  bookingId String
  sitterId  String
  startAt   DateTime
  endAt     DateTime
  status    String   @default("active") // active, expired, closed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  thread  MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  booking Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sitter  Sitter        @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([threadId])
  @@index([bookingId])
  @@index([sitterId])
  @@index([status])
  @@index([startAt, endAt])
}

// ============================================
// PHASE 3: ANTI-POACHING (prepared for Phase 3)
// ============================================

model AntiPoachingAttempt {
  id               String    @id @default(uuid())
  orgId            String
  threadId         String
  eventId          String    @unique // FK to MessageEvent
  actorType        String // client | sitter
  actorId          String?
  violationType    String // phone_number | email | url | social_media
  detectedContent  String    @db.Text // The flagged content
  action           String    @default("blocked") // blocked | warned | flagged
  ownerNotifiedAt  DateTime?
  resolvedAt       DateTime?
  resolvedByUserId String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  event  MessageEvent  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([threadId])
  @@index([eventId])
  @@index([action])
}

// ============================================
// SITTER GROWTH LEVELS SYSTEM (SRS)
// ============================================

model SitterTierSnapshot {
  id                    String   @id @default(uuid())
  orgId                 String
  sitterId              String
  asOfDate              DateTime @db.Date
  rolling30dScore       Float    // 0-100
  rolling30dBreakdownJson String  @db.Text // JSON: { responsiveness, acceptance, timeliness, accuracy, engagement, conduct }
  rolling26wScore       Float?   // 0-100, nullable for new sitters
  rolling26wBreakdownJson String? @db.Text // JSON: same structure
  tier                  String   @default("foundation") // foundation, reliant, trusted, preferred
  provisional           Boolean  @default(false)
  visits30d             Int      @default(0)
  offers30d             Int      @default(0)
  lastPromotionAt       DateTime?
  lastDemotionAt        DateTime?
  atRisk                Boolean  @default(false)
  atRiskReason          String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  sitter                Sitter   @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@unique([orgId, sitterId, asOfDate])
  @@index([orgId, sitterId, asOfDate(sort: Desc)])
  @@index([orgId, asOfDate])
  @@index([sitterId, asOfDate(sort: Desc)])
  @@index([tier])
  @@index([atRisk])
}

model SitterServiceEvent {
  id            String    @id @default(uuid())
  orgId         String
  sitterId      String
  level         String    // coaching, corrective, probation
  reasonCode    String
  notes         String?   @db.Text
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdByUserId String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sitter        Sitter    @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@index([orgId, sitterId, createdAt(sort: Desc)])
  @@index([orgId, sitterId, effectiveFrom, effectiveTo])
  @@index([level])
  @@index([effectiveFrom, effectiveTo])
}

model SitterTimeOff {
  id              String    @id @default(uuid())
  orgId           String
  sitterId        String
  type            String    // pto, medical
  startsAt        DateTime
  endsAt          DateTime
  approvedByUserId String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  sitter          Sitter    @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@index([orgId, sitterId, startsAt, endsAt])
  @@index([orgId, sitterId, startsAt(sort: Desc)])
  @@index([type])
  @@index([startsAt, endsAt])
}

model OfferEvent {
  id                String    @id @default(uuid())
  orgId             String
  sitterId          String
  threadId          String?
  bookingId         String?
  offeredAt         DateTime
  expiresAt         DateTime? // When offer expires (for timeout tracking)
  acceptedAt        DateTime?
  declinedAt        DateTime?
  declineReason     String?    // enum + free text
  source            String     @default("dashboard") // dashboard | sms
  status            String     @default("sent") // sent | accepted | declined | expired
  withinAvailability Boolean   @default(true)
  leadTimeValid     Boolean    @default(true)
  routingValid      Boolean    @default(true)
  excluded          Boolean    @default(false)
  excludedReason    String?    @db.Text
  correlationIds    String?    @db.Text // JSON array
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  sitter            Sitter     @relation(fields: [sitterId], references: [id], onDelete: Cascade)
  booking           Booking?   @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  thread            MessageThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)

  @@index([orgId, sitterId, offeredAt(sort: Desc)])
  @@index([orgId, sitterId, excluded])
  @@index([orgId, sitterId, status])
  @@index([bookingId])
  @@index([threadId])
  @@index([offeredAt])
  @@index([expiresAt])
}

model VisitEvent {
  id                  String    @id @default(uuid())
  orgId               String
  sitterId            String
  clientId            String?
  bookingId           String
  threadId            String?
  scheduledStart      DateTime
  scheduledEnd        DateTime
  checkInAt           DateTime?
  checkOutAt          DateTime?
  status              String    // completed, late, missed, canceled
  lateMinutes         Int?      @default(0)
  checklistMissedCount Int      @default(0)
  mediaMissingCount   Int       @default(0)
  complaintVerified    Boolean   @default(false)
  safetyFlag          Boolean   @default(false)
  excluded            Boolean   @default(false)
  excludedReason      String?   @db.Text
  correlationIds      String?   @db.Text // JSON array
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  sitter              Sitter     @relation(fields: [sitterId], references: [id], onDelete: Cascade)
  booking             Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  thread              MessageThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)

  @@index([orgId, sitterId, scheduledStart(sort: Desc)])
  @@index([orgId, sitterId, excluded])
  @@index([bookingId])
  @@index([threadId])
  @@index([scheduledStart])
  @@index([status])
}

model SitterCompensation {
  id                  String    @id @default(uuid())
  orgId               String
  sitterId            String    @unique
  basePay             Float     @default(12.50)
  lastRaiseAt         DateTime?
  lastRaiseAmount     Float?
  nextReviewDate      DateTime?
  perkFlags           String?   @db.Text // JSON: { priority, multipliers, mentorship, reducedOversight }
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  sitter              Sitter    @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@index([orgId, sitterId])
  @@index([nextReviewDate])
}

model SitterMetricsWindow {
  id                  String    @id @default(uuid())
  orgId               String
  sitterId            String
  windowStart         DateTime
  windowEnd           DateTime
  windowType          String     // daily | weekly_7d | monthly_30d
  avgResponseSeconds  Float?
  medianResponseSeconds Float?
  responseRate        Float?     // responded threads / total requiring response
  offerAcceptRate     Float?     // accepted / total offers
  offerDeclineRate    Float?     // declined / total offers
  offerExpireRate     Float?     // expired / total offers
  lastOfferRespondedAt DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  sitter              Sitter     @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@unique([orgId, sitterId, windowStart, windowType])
  @@index([orgId, sitterId, windowStart])
  @@index([orgId, sitterId, windowEnd])
  @@index([windowType])
}

model MessageResponseLink {
  id                    String    @id @default(uuid())
  orgId                 String
  threadId              String
  requiresResponseEventId String  // FK to MessageEvent (the message requiring response)
  responseEventId       String    // FK to MessageEvent (the response)
  responseMinutes       Int       // Calculated response time in minutes
  responseSeconds       Int?      // More precise response time in seconds
  withinAssignmentWindow Boolean  @default(false)
  excluded              Boolean   @default(false)
  excludedReason        String?   @db.Text
  createdAt             DateTime  @default(now())

  // Relations
  requiresResponseEvent MessageEvent @relation("RequiresResponse", fields: [requiresResponseEventId], references: [id], onDelete: Cascade)
  responseEvent         MessageEvent @relation("Response", fields: [responseEventId], references: [id], onDelete: Cascade)
  thread                MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([requiresResponseEventId]) // One response per requiring message
  @@index([orgId, threadId, createdAt(sort: Desc)])
  @@index([orgId, requiresResponseEventId])
  @@index([responseEventId])
  @@index([withinAssignmentWindow, excluded])
}

// ============================================
// GOOGLE CALENDAR INTEGRATION
// ============================================

model BookingCalendarEvent {
  id                  String    @id @default(uuid())
  bookingId           String
  sitterId            String
  googleCalendarEventId String // Google Calendar event ID
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  booking             Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sitter              Sitter    @relation(fields: [sitterId], references: [id], onDelete: Cascade)

  @@unique([bookingId, sitterId]) // One event per booking-sitter pair
  @@index([bookingId])
  @@index([sitterId])
  @@index([googleCalendarEventId])
}
